{% extends "base.html" %} {% block content %}

<style>
  .alertmessage{
      position: fixed; 
      top: 1px; 
      left:55%;
      transform: translateX(-50%); 
      padding: 30px 30px; 
      background-color: #4CAF50; 
      color: white; 
      font-size: 16px; 
      border-radius: 3px; 
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
      z-index: 1000; 
      width: 50%; /* This makes the alert have the same width as col-6 */
  }
</style>

<div class="content">
  <div class="container-fluid">
    <div class="col-1">
      <button class="btn" onclick="window.history.back()" style="background-color:#01052b;color:white;">            <i class="material-icons">arrow_back</i>
      </button>
      </div>
    
    <div class="row text-center">
      
      <h2
        class="font-weight-bold"
        style="font-family: poppins, serif; color: #4b0000"
      >
        Add Booking
      </h2>
    </div>
    <div class="row">
      
        <!-- Success message container -->
        <div id="success-message" class="alert alert-success text-center font-weight-bold alertmessage" role="alert" style="display: none; margin-top: 20px;">
          Booking added successfully!
        </div>

        <div id="error-message" class="alert alert-danger text-center font-weight-bold alertmessage" role="alert" style="display: none; margin-top: 20px;">
          
        </div>
      
    </div>
    <div class="row mt-4">
      

      <div class="col-lg-6 col-md-12 col-md-12  pt-3 text-black">
        <div class="card">
          <div class="card-header card-header-rose card-header-icon">
            <div class="card-icon">
                <i class="material-icons">add</i>
            </div>
          </div>
          <div class="card-body">

          
        <form action="" method="post" enctype="multipart/form-data" class="form-horizontal text-black pt-2 pl-3 pr-3" id="supform">
          {% csrf_token %}

          
          <div class="company rounded border pt-3 pl-3 pr-3 pb-5">
            <div class="col-12">
              <h5 class="text-center font-weight-bold mb-3">Company Details</h5>

              <div class="form-group">
                <label for="id_company" class="bmd-label-floating text-black">Company/Customer</label>


                {{form.company}} {% if form.company.errors %}
                <ul class="errorlist text-primary text-bold">
                  {% for error in form.company.errors %}
                  <li>{{ error }}</li>
                  {% endfor %}
                </ul>
                {% endif %}
              </div>
            </div>

          <div class="col-12 mt-3">
            <div class="form-group">
              <label for="id_company" class="bmd-label-floating text-black">Contact Person</label>


              {{form.contact_person}} {% if form.contact_person.errors %}
              <ul class="errorlist text-primary text-bold">
                {% for error in form.contact_person.errors %}
                <li>{{ error }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
          </div>
        </div>

             

        <div class="row mt-5 mb-1">
          <div class="formset-container">
              <!-- Management form for the formset -->
              {{ formset.management_form }}
              
              <!-- Iterate over each form in the formset -->
              {% for form in formset %}
              <div class="formset mt-2 pl-3 pr-2">
                
                  <h3 class="text-center font-weight-bold mb-3">Booking Details</h3>
                  <div class="row">
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"></div>
                    <div class="col-1"><i class="material-icons delete-form" style="cursor: pointer; color: #4b0000; font-size: 36px; letter-spacing: 1px;">close</i>
                    </div>
                  </div>
      
                  <div class="row pl-3">
                      <!-- Guest details section -->
                      <div class="row guest-details rounded border pt-3 pl-2 pr-2 pb-4 mb-5">
                          <h5 class="text-center font-weight-bold mb-5 mt-2">Guest Details</h5>
      
                          {% for field in form %}
                              {% if field.name == 'guest_name' or field.name == 'email' or field.name == 'contact_number' or field.name == 'whatsapp_number' %}
                              <div class="col-md-6 mb-3 dynamic-field" data-field-name="{{ field.name }}">
                                  <div class="form-group">
                                      <label for="{{ field.id_for_label }}" class="text-black">{{ field.label }}</label>
                                      {{ field }}
                                  </div>
                              </div>
                              {% endif %}
                          {% endfor %}
                      </div>
      
                      <!-- Trip details section -->
                      <div class="row trip-details rounded border pt-3 pl-2 pr-2 pb-4 mb-5">
                          <h5 class="text-center font-weight-bold mb-5 mt-2">Trip Details</h5>
      
                          {% for field in form %}
                              {% if field.name != 'guest_name' and field.name != 'email' and field.name != 'contact_number' and field.name != 'whatsapp_number' and field.name != 'remark' %}
                              <div class="col-md-6 mb-3 dynamic-field" data-field-name="{{ field.name }}">
                                  <div class="form-group">
                                      {% if field.name != 'booking_trip_id' and field.name != 'booking' and field.name != 'is_deleted' %}
                                      <label for="{{ field.id_for_label }}" class="text-black">{{ field.label }}</label>
                                      {% endif %}
                                      {{ field }}
                                  </div>
                              </div>
                              {% endif %}
                          {% endfor %}
      
                          <!-- Add remark field at the bottom of the trip details section with col-12 (full width) -->
                          <div class="col-12 mb-3 dynamic-field" data-field-name="remark">
                              <div class="form-group">
                                  <label for="{{ form.remark.id_for_label }}" class="text-black">{{ form.remark.label }}</label>
                                  {{ form.remark }}
                              </div>
                          </div>
                      </div>
      
                      {% if forloop.counter|divisibleby:3 %}
                      <div class="row">
                      {% endif %}
                      
                  </div>
              </div>
              {% endfor %}
          </div>
      
          <!-- Add Button to dynamically add new contact forms -->
          <div class="row mb-4">
              <div class="col-3"></div>
              <div class="col-6">
                  <button type="button" class="btn w-100" id="add-form" style="background-color:#002f75;color:white;">Add Another Trip</button>
              </div>
          </div>
      </div>
      
      
      
            
          

          


          
      <div class="row pl-3 pr-3">
        <div class="payment rounded border pt-3 pl-2 pr-2 pb-5 mb-5">
          <h5 class="text-center font-weight-bold mb-3">Payment Details</h5>

          <div class="col-12 mt-2">
            <label for="" class="text-black">Payment ref No :</label>
            <div class="form-group">
              {{form.payment_ref_no}} {% if form.payment_ref_no.errors %}
              <ul class="errorlist text-primary text-bold">
                {% for error in form.payment_ref_no.errors %}
                <li>{{ error }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
          </div>


          <div class="col-12 mt-2">
            <label for="" class="text-black">Payment Status</label>
            <div class="form-group">
              {{form.payment_status}} {% if form.payment_status.errors %}
              <ul class="errorlist text-primary text-bold">
                {% for error in form.payment_status.errors %}
                <li>{{ error }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
          </div>

          <div class="col-12 mt-2">
            <label for="" class="text-black">Payment Mode</label>
            <div class="form-group">
              {{form.payment_mode}} {% if form.payment_mode.errors %}
              <ul class="errorlist text-primary text-bold">
                {% for error in form.payment_mode.errors %}
                <li>{{ error }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

        <div class="pl-2 pr-2">
          <div class="col-12 mt-2 ">
            <label for="" class="text-black">Status</label>
            <div class="form-group">
              {{form.status}} {% if form.status.errors %}
              <ul class="errorlist text-primary text-bold">
                {% for error in form.status.errors %}
                <li>{{ error }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
          </div>
        </div>

          


          <div class="row mt-5">
            <div class="col-3"></div>
            <div class="col-6">
              <button type="submit" class="btn btn-rose w-100">
                Add Booking
              </button>
            </div>
            <div class="col-3"></div>
          </div>
        </form>
      </div>
    </div>
      </div>
    </div>
    <div class="col-6"></div>
  </div>
</div>





<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  
    $(document).ready(function () {
        // Event listener for category change (this will populate the package dropdown)
        $(document).on('change', '[id^="id_bookingtripdetails-"][id$="-category"]', function () {
            var $categoryField = $(this);
            var categoryId = $categoryField.val();
  
            // Dynamically determine the package dropdown related to the changed category field
            var packageFieldId = $categoryField.attr('id').replace('-category', '-package');
            var $packageDropdown = $('#' + packageFieldId);
            
  
            $packageDropdown.empty(); // Clear existing options
  
            if (categoryId) {
                $.ajax({
                    url: "{% url 'get_package' %}",  // Assuming you have a Django view for this
                    data: { category_id: categoryId },
                    success: function (data) {
                        $packageDropdown.append('<option value="">Select Package</option>');
                        data.forEach(function (pkg) {
                            $packageDropdown.append('<option value="' + pkg.package_id + '">' + pkg.package_title + '</option>');
                        });
                    },
                    error: function () {
                        alert('Unable to fetch packages. Please try again later.');
                    }
                });
            }
        });

        // Event listener for package change (this will populate the rates fields)
        $(document).on('change', '[id^="id_bookingtripdetails-"][id$="-package"]', function () {
            var $packageField = $(this);
            var packageId = $packageField.val();

            // Dynamically determine the related rate fields (adult, child, infant)
            var formIndex = $packageField.attr('id').split('-')[1]; // Assuming form index is part of the ID
            var $adultRateField = $('#id_bookingtripdetails-' + formIndex + '-rate_of_adult');
            var $childRateField = $('#id_bookingtripdetails-' + formIndex + '-rate_of_child');
            var $infantRateField = $('#id_bookingtripdetails-' + formIndex + '-rate_of_infant');

            if (packageId) {
                $.ajax({
                    url: "{% url 'get_package_rates' %}",
                    data: { package_id: packageId },
                    success: function (data) {
                        if (data.error) {
                            alert('Package not found.');
                        } else {
                            // Set the rates in the corresponding fields
                            $adultRateField.val(data.adult_rate);
                            $childRateField.val(data.child_rate);
                            $infantRateField.val(data.infant_rate);
                        }
                    },
                    error: function () {
                        alert('Unable to fetch package rates. Please try again later.');
                    }
                });
            } else {
                // Clear the rate fields if no package is selected
                $adultRateField.val('');
                $childRateField.val('');
                $infantRateField.val('');
            }
        });
    });




  $(document).on('change', '[id^="id_company"]', function () {
    var $companyField = $(this);
    var companyId = $companyField.val();

    // Dynamically determine the contact person dropdown related to the changed company field
    var contactPersonFieldId = $companyField.attr('id').replace('_company', '_contact_person');
    var $contactPersonDropdown = $('#' + contactPersonFieldId);

    $contactPersonDropdown.empty(); // Clear existing options

    if (companyId) {
        $.ajax({
            url: "{% url 'get_contact_persons' %}",
            data: { company_id: companyId },
            success: function (data) {
                $contactPersonDropdown.append('<option value="">Select Contact Person</option>');
                data.forEach(function (contact) {
                    $contactPersonDropdown.append('<option value="' + contact.id + '">' + contact.name + ' (' + contact.designation + ')</option>');
                });
            },
            error: function () {
                alert('Unable to fetch contact persons. Please try again later.');
            }
        });
    }
});





  $(document).on('change', '[id^="id_bookingtripdetails-"][id$="-category"]', function () {
    var $categoryField = $(this); // The category dropdown that was changed
    var categoryId = $categoryField.val(); // Get the selected category ID

    // Get the form this category field belongs to
    var $form = $categoryField.closest('.formset');

    if (categoryId) {
        // AJAX call to get field visibility based on the selected category
        $.ajax({
            url: "{% url 'get_category_fields' %}",
            data: { category_id: categoryId },
            success: function (response) {
                if (response.success) {
                    var fields = response.fields;

                    // Show all fields in the form by default
                    $form.find(".dynamic-field").show();

                    // Hide fields marked as false
                    for (var fieldName in fields) {
                        if (!fields[fieldName]) {
                            $form.find("[data-field-name='" + fieldName + "']").hide();
                        }
                    }
                } else {
                    alert(response.error || 'Unable to fetch category field data.');
                }
            },
            error: function () {
                alert('Unable to fetch category field data. Please try again.');
            }
        });
    } else {
        // If no category is selected, show all fields by default
        $form.find(".dynamic-field").show();
    }
});

  
</script>



<script>
  

  document.addEventListener('DOMContentLoaded', function() {
    // Function to handle form cloning
    document.querySelector('#add-form').addEventListener('click', function() {
        // Calculate the index based on the current number of formsets
        var formIdx = document.querySelectorAll('.formset').length;
        console.log(formIdx); // Debugging the current form index

        // Clone the last form in the formset (instead of the first)
        var lastForm = document.querySelector('.formset:last-of-type');
        var newForm = lastForm.cloneNode(true);

        // Replace __prefix__ in name and id with the new form index
        const regex = /__prefix__/g;
        newForm.innerHTML = newForm.innerHTML.replace(regex, formIdx);

        // Set the new ID for the form
        newForm.setAttribute('id', `formset${formIdx}`);

        // Update all input fields in the new form with the correct index
        updateFieldIdsAndNames(newForm, formIdx);

        // Reset input values for the new form
        resetFormValues(newForm);

        // Append the new form to the container (formset-container is assumed to be the container for forms)
        document.querySelector('.formset-container').appendChild(newForm);

        // Update the TOTAL_FORMS field (management form)
        updateManagementForm();
    });

    // Function to handle form deletion
    document.addEventListener('click', function(event) {
        if (event.target && event.target.matches('.delete-form')) {
            event.preventDefault();

            // Find the formset that the delete button belongs to
            var formToDelete = event.target.closest('.formset'); // Finds the closest parent with class .formset

            if (formToDelete) {
                formToDelete.remove(); // Remove the respective formset

                // Update management form (if necessary)
                updateManagementForm();
            }
        }
    });

    // Function to update the TOTAL_FORMS field in the management form
    function updateManagementForm() {
        var forms = document.querySelectorAll('.formset');
        var managementForm = document.getElementById('id_bookingtripdetails-TOTAL_FORMS');
        managementForm.value = forms.length;
    }

    // Function to update the ID and name attributes for fields in the cloned form
    function updateFieldIdsAndNames(newForm, formIdx) {
        var fields = ['guest_name', 'email', 'contact_number', 'whatsapp_number', 'supplier', 'category', 'package', 'trip_date', 'trip_time', 
                      'no_of_adult', 'no_of_child', 'no_of_infant', 'rate_of_adult', 'rate_of_child', 'rate_of_infant', 'transfer_type', 
                      'vehicle_type', 'vehicle_name', 'no_of_luggage', 'flight_time', 'remark', 'room_no', 'pickup_location', 'drop_location', 'pickup_time'];

        fields.forEach(function(field) {
            var fieldElement = newForm.querySelector(`#id_bookingtripdetails-0-${field}`);
            if (fieldElement) {
                fieldElement.setAttribute('id', `id_bookingtripdetails-${formIdx}-${field}`);
                fieldElement.setAttribute('name', `bookingtripdetails-${formIdx}-${field}`);
            }
        });
    }

    // Function to reset input values for the new form
    function resetFormValues(newForm) {
        var inputs = newForm.querySelectorAll('input, select, textarea');
        inputs.forEach(function(input) {
            input.value = ''; // Clear the value of each field
        });
    }
});


let supform=document.getElementById('supform');
supform.addEventListener('submit',function(event){
    event.preventDefault();
    let formData = new FormData(supform);
    $.ajax({
        type:"POST",
        url:"{% url "add_booking" %}",
        data: formData,
        processData: false,
        contentType: false,
        dataType:'json',
        success:function(response){
          console.log('AJAX request Successfull');
          if(response.success){
            showSuccessMessage();
            supform.reset();
          }
          else{
            showErrorMessage(response.errors);
            console.log("form Submission errors :", response.errors);
          }
        },
        error:function(xhr,Status,error){
          showErrorMessage("An Unexpected Error Occurs Please Try again Later");
          console.error("AJAX request failed:",status,error);
          console.log("Response Text :",xhr.responseText)
        }
    });
});


function showSuccessMessage() {
  let successMessage = document.getElementById('success-message');
  successMessage.style.display = 'block';

  // Hide the message after 3 seconds
  setTimeout(function() {
      successMessage.style.display = 'none';
  }, 3000);
}

function showErrorMessage(errors) { 
let errorMessage = document.getElementById('error-message'); 
errorMessage.innerHTML = ''; 
if (typeof errors === 'string') { 
  errorMessage.innerHTML = errors; 
} 
else { 
  for (let key in errors) { 
    if (errors.hasOwnProperty(key)) { 
      let errorText = `${errors[key]}`; 
      let errorItem = document.createElement('div'); 
      errorItem.innerText = errorText; errorMessage.appendChild(errorItem);
     } 
    } 
  }
  errorMessage.style.display = 'block';
   // Hide the message after 5 seconds 
   setTimeout(function() { errorMessage.style.display = 'none'; }, 5000); 
}


</script> 





{% endblock content %}
